{% extends "__layout_left_sidebar.html" %}

{% block sidebar_content %}
	{% include "_deck_nav.html" with collection=collection deck=deck is_quiz_mode=is_quiz_mode %}
{% endblock %}

{% block main_content %}

<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'>


<div id="content"><!-- content (start) -->

    <div class="courseWrapper"><!-- courseWrapper (start) -->

        <div class="courseHeader"><!-- courseHeader (start) -->

            <h2 class="courseTitle">{{collection.title}}</h2><h3>{{deck.title}}</h3>
            {% if collection.id in user_collection_role.ADMIN %}
            <ul class="adminMenu adminMenuRight">
                <li><a href="#">Edit</a></li>
                <li><a href="#">Delete</a></li>
                <li>
                {% if is_quiz_mode %}
                <a href="{% url 'deckIndex' deck.id %}" onclick="location.href=this.href+'?cardLoc='+(current+1);return false;">Review Mode</a>
                {% else %}
                <a href="{% url 'deckIndex' deck.id %}?mode=quiz" onclick="location.href=this.href+'&cardLoc='+(current+1);return false;">Quiz Mode</a>
                {% endif %}
                </div>
            </ul>
            {% endif %}

        </div><!-- courseHeader (end) -->
		{% if user.is_authenticated %}
        <a href="#" id="addCard">Add Card</a>
        <div id="cardSlider">
        {% else %}
        <div id="cardSliderNotAdmin">
        {% endif %}
        {% if cards|length %}
        <div class="sliderBtns deckPrev">
            <a href="javascript:sliders[0].goToPrev()"><i class="fa fa-angle-left"></i><span>Prev</span></a>
            <a href="javascript:sliders[0].goToFirst()"><i class="fa fa-angle-double-left"></i><span>First</span></a>
        </div>
        <div class="cardHolder" id="holder" style="display:none;">

            <ul id="cards">
                {% for card in cards %}
                <li id = {{forloop.counter0}}>
                    <a class="image" href="javascript:sliders[0].goToCard({{forloop.counter0}}); current = {{forloop.counter0}}">
                            {% for field in card.fields.reveal %}
                                {% include "_deck_slider_card_fields.html" with field=field %}
                            {% endfor %}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div class="sliderBtns deckNext">
            <a href="javascript:sliders[0].goToNext()"><i class="fa fa-angle-right"></i><span>Next</span></a>
            <a href="javascript:sliders[0].goToLast()"><i class="fa fa-angle-double-right"></i><span>Last</span></a>
        </div>
        {% endif %}
        </div>




        <div id="cardform"><!-- singleCardHolder (start)-->
            <div class="courseWrapper addCourseWrapper" id="addCardForm">
                <div class="courseHeader"><!-- courseHeader (start) -->
					<h2>Create a New Card</h2>
                    <ul class="adminMenu adminMenuRight">
							<li><a href="#" id="card_cancel">Cancel</a></li>
					</ul>
			    </div><!-- courseHeader (end) -->
                <div style="display:none;" id="readroot">
                    Label: <input type="text" name="Label">
                    Value: <input type="text" name="Value">
                    <select name="Field Type">
                    <option value="T" selected>Text</option>
                    <option value="I">Image</option>
                    <option value="V">Video</option>
                    <option value="A">Audio</option>
                    </select>
                    <input type="checkbox" name="showLabel" value="showLabel">Show Label
                    <input type="checkbox" name="display" value="display">Display
                    <ul class="adminMenu adminMenuRight">
                            <li><a href="#" onclick="this.parentNode.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode.parentNode);counter=counter-1;return false;">Remove Field</a></li>
					</ul>
                    <br />
                </div>
                <form method="post" id="addcardform" action="/card/create/">
                    {% csrf_token %}
                    <span id="writeroot"></span>
                    <input id="deck_id" name="deck_id" type="hidden" />
                    <input id="collection_id" name="collection_id" type="hidden" value="{{collection.id}}" />
                    <input id="max_card_id" name="max_card_id" type="hidden" value="{{cards|length}}" />
                    <input id="num_fields" name="num_fields" type="hidden" />
                    <input id="quiz_mode" name="quiz_mode" type="hidden" value="{{is_quiz_mode}}" />

                    <ul class="adminMenu">
                            <li><a href="#" id="moreFields">Add another field</a></li>
                        	<li><a href="#" id="card_create">Create</a></li>
					</ul>
                </form>
            </div>
        </div>

        <div id="singleCardHolder"><!-- singleCardHolder (start)-->

            <!--div id="slider"></div-->
            <!--div class = "controls" id="controlbar">
              <div style='float: left;' id ='first'>
                <a id="first_card" href="#">First</a>
              </div>
              <div style='float: left;' id="previous">
                <a id="previous_card" href="#">Previous</a>
              </div>
              <div style ='float:left;' id="cardIndex">
                <div style="text-align:center;" id="cardLoc"></div>
              </div>
              <div style='float: right;' id="last">
                <a id="last_card" href="#">Last</a>
              </div>
              <div style='float: right;' id="next">
                <a id="next_card" href="#">Next</a>
              </div>

            </div-->
            <div id="cardOverflow"><!-- cardOverflow (start) -->
                <ul id="allCards">
                    {% for card in cards %}
                    <li class="hide">
                        {% for field in card.fields.reveal %}
                            {% include "_deck_card_fields.html" with field=field %}
                        {% endfor %}
                        <div class="hideRevealHr">
                            {% if is_quiz_mode %}
                            <a href="#" class="reveal">Reveal</a>
                            {% endif %}
                        </div>
                        <div class="{% if is_quiz_mode %}hide{% endif %}">
                        {% for field in card.fields.show %}
                            {% include "_deck_card_fields.html" with field=field hide=is_quiz_mode%}
                        {% endfor %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div><!-- cardOverflow (end) -->
        </div><!-- singleCardHolder (end)-->
\    </div><!-- courseWrapper (end) -->

</div><!-- content (end) -->

</div><!-- contentWrapper (end) -->


<script type="text/javascript">
require(['jquery', 'lib', 'appendAround', 'jqueryui'], function($, lib) {
counter = 0;

function moreFields() {
	counter++;
	var newFields = document.getElementById('readroot').cloneNode(true);
	newFields.id = '';
	newFields.style.display = 'block';
	var newField = newFields.childNodes;
	for (var i=0;i<newField.length;i++) {
		var theName = newField[i].name
		if (theName)
			newField[i].name = theName + counter;
	}
	var insertHere = document.getElementById('writeroot');
	insertHere.parentNode.insertBefore(newFields,insertHere);
}
$('#moreFields').click(function(){
    moreFields();
    return false;
});
window.onload = moreFields;

function extractDeckId(){
    var pathname = $(location).attr('href');
    var res = String(pathname.match('[^/]+$'));
    res = res.match('([0-9]+).*');
    res = res.slice(1);
    return res;
};

document.getElementById('card_create').onclick = function(){
        document.getElementById("deck_id").value = extractDeckId();
        document.getElementById("num_fields").value = counter;
        if(counter!=0)
            document.getElementById('addcardform').submit();
        return false;
    };

$('#addCard').click(function(){
    document.getElementById('cardform').style.display="block";
    document.getElementById('addCardForm').style.display="block";
    return false;
});
$('#card_cancel').click(function(){
    document.getElementById('cardform').style.display="none";
    document.getElementById('addCardForm').style.display="none";
    return false;
});


function parseURLParams(url) {
    var queryStart = url.indexOf("?") + 1,
        queryEnd   = url.indexOf("#") + 1 || url.length + 1,
        query = url.slice(queryStart, queryEnd - 1),
        pairs = query.replace(/\+/g, " ").split("&"),
        parms = {}, i, n, v, nv;

    if (query === url || query === "") {
        return;
    }

    for (i = 0; i < pairs.length; i++) {
        nv = pairs[i].split("=");
        n = decodeURIComponent(nv[0]);
        v = decodeURIComponent(nv[1]);

        if (!parms.hasOwnProperty(n)) {
            parms[n] = [];
        }

        parms[n].push(nv.length === 2 ? v : null);
    }
    return parms;
}

var pathname = $(location).attr('href');
var urlPar = parseURLParams(pathname);
current = 0;
if(typeof(urlPar) != "undefined"){
if(typeof(urlPar["cardLoc"]) != "undefined"){current = Number(urlPar["cardLoc"][0])-1}
}
sliders = [];
sliderLength = $('ul#cards li').size();

$( "#slider" ).slider({
        orientation: "horizontal",
        min: 0,
        range: "min",
        max: sliderLength-1,
        step: 1,
        slide:function(event, ui){sliders[0].goToCard(ui.value)}
});


var sliderObjExist = false;
var Slider1 = lib.Slider;
$('.cardHolder').each(function() {
	if ( $(this).text() != '' ){
		//create Slider objects
		sliders.push(new Slider1(this,true));
		//sliders[i].respond();
		sliderObjExist = true;
	}
});
sliders[0].goToCard(current);
// fixes the reorganization of slider
document.getElementById("holder").style.display="block";
document.getElementById("allCards").style.display="block";



function updateCardLoc(loc){
    numCards = sliderLength;
	var location = Math.round((loc+1)/sliderLength*100) + '%  •  Card '+ (loc + 1) + ' of ' + sliderLength;
	$('#cardLoc').text(location);
	$( "#slider" ).slider( "value", loc );
}


$(window).on("resize", function () {
    // to display the card location between the control buttons
    spaceBtwControls = $('#controlbar').width()- $('#first').width()-$('#last').width()-$('#next').width()-$('#previous').width();
    $('#cardIndex').width(spaceBtwControls + 'px');

	if ( sliderObjExist )
	{
		//console.log($('.sliderNav').css('display'));
		sliders[0].respond();

	}
/* //RM
	var cardHolder = $('#singleCardHolder');
	var holderWidth = Math.round(cardHolder.width());
	var cardItems = $('#singleCardHolder ul li');
	var liCount = cardItems.length;
	//give each a card li the width of the container
	cardItems.width(holderWidth + 'px');
	//make the ul width big enough to fit all cards side by side
	var ulWidth = holderWidth * liCount;
	$('#singleCardHolder ul').width(ulWidth + 'px');

	//on first load show the first card
	cardItems.eq(current).show();
	sliders[0].goTo(current);

    updateCardLoc(current);
	document.getElementById(current).className = "clicked"
*/
	//change main card based on thumbnail click
	/*$('a.image').click(function(){
		var i = $(this).parent().index();

		if (i != current)
		{
			cardItems.eq(current).hide();
			document.getElementById(current).className = "";
            sliders[0].changeView(i);
			cardItems.eq(i).show();

			updateCardLoc(i);
			document.getElementById(i).className = "clicked"
			current = i;
		}
        else if (i===0 || i===sliderLength-1)
            sliders[0].goTo(i)

	});*/


}).resize();


$('.reveal').click(function() {
	var $show = $(this).parent().next();
	if ($show.hasClass('show')){
		$show.removeClass('show');
		$show.addClass('hide');
		$(this).text('Reveal');
	}else{
		$show.removeClass('hide');
		$show.addClass('show');
		$(this).text('Hide');
	}
	return false;
});



});

</script>

<script type="text/javascript">
require(['jquery', 'jquery.mousewheel'], function($) {

$('#previous_card').click(function() {
    sliders[0].changeCard(-1);
    return false;
});
$('#next_card').click(function() {
    sliders[0].changeCard(1);
    return false;
});

$('#first_card').click(function() {
    sliders[0].firstCard();
    return false;
});

$('#last_card').click(function() {
    sliders[0].lastCard();
    return false;
});

// scroll through the slider using horizontal mousewheel/touchpad

$('#cardSlider').mousewheel(function(event) {
      if (event.deltaX>0){
        event.preventDefault();
        sliders[0].goToNext();
      }
      else if (event.deltaX<0){
      	event.preventDefault();
        sliders[0].goToPrev();
      }
});

function checkKey(e) {
    var event = window.event ? window.event : e;
    if (true) {
        if (event.keyCode == 37)
            sliders[0].goToPrev()
        if (event.keyCode == 39)
            sliders[0].goToNext()
    }
};
document.onkeydown=checkKey;

});
</script>

{% endblock %}
