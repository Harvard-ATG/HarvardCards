{% extends "base.html" %}

{% block content %}
<div class="row-fluid">
	<nav class="span4 collection-sidenav">
		<ul class="nav nav-list affix collection-list">
			{% for collection in collections %}
			<li class="collection-list-item" data-id="{{ collection.id }}"><a href="#course-{{ collection.id }}">{{ collection.title }}<i class="icon-chevron-right pull-right"></i></a></li>
			{% endfor %}
			<li class="no-collections-item {% if collections %}hide{% endif %}"><a href="#">No Collections</a></li>
			<li>
				<ul class="unstyled inline">
					<li><button id="add_collection_button" class="btn">+</button></li>
					<li><button id="delete_collection_confirm_button" class="btn">-</button></li>
					<li><button class="btn">++</button></li>
					<li><button id="edit_collection_button" class="btn">E</button></li>
				</ul>
			</li>
		</ul>
		
		
		<div id="collectionDeleteModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="collectionDeleteModalLabel" aria-hidden="true">
		  <div class="modal-header">
		    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
		    <h3 id="collectionDeleteModalLabel">Confirm Delete</h3>
		  </div>
		  <div class="modal-body">
		    <p>Are you sure you want to delete this Course?</p>
		  </div>
		  <div class="modal-footer">
		    <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
		    <button id="delete_collection_button" class="btn btn-error">Delete Course</button>
		  </div>
		</div>
	</nav>
	
	<section class="span8 collection-decks-section">
		<ul class="unstyled">
			{% for collection in collections %}
			<li id="course-{{ collection.id }}">
				<div class="cds-top">
					<h5>{{ collection.title }}</h5>
					<em>{{ collection.description }}</em>
				</div>
				<div class="cds-bottom">
					<ul class="inline">
						<li class="new-deck-btn" data-collection_id={{collection.id}}>
							<div class="new-deck-btn-text ">+ Add new Deck</div>
						</li>
						{% for deck in collection.deck_set.all %}
						<li class="deck" data-deck_id={{deck.id}}>
							<div class="deck-text" data-deck_id={{deck.id}}>{{ deck.title }}</div>
							<div class="deck-controls hide">
								<span class="deck-review-btn">Review</span>
								<span class="deck-study-btn">Study</span>
							</div>
							<div class="deck-delete-btn hide">X</div>
						</li>
						{% endfor %}
					</ul>
				</div>
			</li>
			{% endfor %}
			<li class="no-collections-item {% if collections %}hide{% endif %}">
				<div class="cds-top">
					<h5>No Collections</h5>
				</div>
			</li>			
		</ul>
	</section>
</div>

<script>
$(document).ready(function(){
	$('#add_collection_button').click(function(){
		window.location = "/collection/create";
	});
	$('#delete_collection_confirm_button').click(function(){
		if($('.active-collection').length){
			$('#collectionDeleteModal').modal();
			
		}
	});
	$('#delete_collection_button').click(function(){
		collection_id = $('.active-collection').parent().data("id");
		// send to the delete
		$.ajax({
			url: '/collection/delete',
			data: {id: collection_id},
			success: function(data, statusText){
				if(data.success){
					$('#collectionDeleteModal').modal('hide');
					// remove item from UI
					$('.active-collection').parent().remove();
					$('#course-' + collection_id).remove();
					// if it's the last one removed, make sure the no-collections-items are shown
					if($('.collection-list-item').length == 0)
						$('.no-collections-item').removeClass("hide");
				} else {
					alert("Error deleting.")
				}
			},
			error: function(request, statusText){
				alert("Request failed.");
			}
		});
	});
	$('#edit_collection_button').click(function(){
		collection_id = $('.active-collection').parent().data("id");
		window.location = "/collection/create/" + collection_id;
	});
	$('.collection-list-item a').click(function(){
		$('.active-collection').removeClass("active-collection");
		// setting it on the a because of the bgcolor
		$(this).addClass("active-collection");
	});
	
	deckCount = 0;
	$('.new-deck-btn').click(function(){
		// new temporary ID for the element
		tempId = 'tmpdeck'+deckCount;
		// create a new <li> there
		var deckTmpl = '<li class="deck"><div id="'+tempId+'" class="deck-text">Deck Name</div></li>';
		$(this).parent().append(deckTmpl);
		var collection_id = $(this).data('collection_id');
		//console.log("collection_id: "+ collection_id);
		// add the editable field
		$('#'+tempId).editable(function(value, settings){
			return value;
		}, { 
			tooltip   : 'Click to edit...',
			cssclass: 'editable',
			style: 'inherit',
			onblur: 'submit',
			// save it when done editing...
			callback: function(value, settings){
				// send ajax to save it
				$.ajax({
					type: 'POST',
					url: '/deck/create/',
					data: {title: $('#'+tempId).html(), collection_id: collection_id},
					success: function(data, statusText){
						if(data.success){
						
						} else {
							alert("Error: "+data.message)
						}
					},
					error: function(request, statusText){
						alert("Request failed.");
					}
				});
				
				// add data to element
				
			}
		});
		// activate it
		$('#'+tempId).trigger('click');
				
		deckCount++;
	});
	
	$('.deck-text').editable(function(value, settings){
		return value;
	}, { 
		tooltip   : 'Click to edit...',
		cssclass: 'editable',
		style: 'inherit',
		onblur: 'submit',
		// save it when done editing...
		callback: function(value, settings){
			// send ajax to save it
			$.ajax({
				type: 'POST',
				url: '/deck/create/',
				data: {title: $(this).html(), deck_id: $(this).data('deck_id')},
				success: function(data, statusText){
					if(data.success){
					
					} else {
						alert("Error: "+data.message)
					}
				},
				error: function(request, statusText){
					alert("Request failed.");
				}
			});
			
			// add data to element
			
		}
	});
	$('.deck').mouseover(function(){
		$(this).children('.deck-controls').removeClass('hide');
		$(this).children('.deck-delete-btn').removeClass('hide');
		
	});
	$('.deck').mouseout(function(){
		$(this).children('.deck-controls').addClass('hide');
		$(this).children('.deck-delete-btn').addClass('hide');
		
	});
	
	$('.deck-delete-btn').click(function(){
		listItem = $(this).parent();
		$.ajax({
			type: 'POST',
			url: '/deck/delete/',
			data: {deck_id: listItem.data('deck_id')},
			success: function(data, statusText){
				if(data.success){
					listItem.remove();
				} else {
					alert("Error: "+data.message)
				}
			},
			error: function(request, statusText){
				alert("Request failed.");
			}
		});
	});
});
</script>
{% endblock %}